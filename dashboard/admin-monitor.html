<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”»æ“Šç›£æ§å„€è¡¨æ¿ - Mini WAF</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <script>
        tailwind.config = { darkMode: "class" };
    </script>

    <style>
        body {
            background-color: #0f172a;
        }

        .card {
            @apply bg-gray-800 p-6 rounded-xl shadow-md border border-gray-700;
        }

        .sticky-header {
            position: sticky;
            top: 0;
            background-color: #1e293b;
            z-index: 10;
        }
        .stat-card {
            @apply bg-gray-800 border border-gray-700 rounded-xl shadow-lg p-6
                  transition duration-200 hover:shadow-xl hover:border-gray-500;
        }

        .stat-title {
            @apply text-sm tracking-wide text-gray-400 mb-1;
        }

        .stat-value {
            @apply text-4xl font-extrabold text-white leading-tight;
        }

        .stat-value-small {
            @apply text-lg font-semibold text-white leading-tight truncate;
        }
    </style>
</head>

<body class="dark min-h-screen p-8 text-gray-100">

<div class="max-w-7xl mx-auto">

    <!-- æ¨™é¡Œ -->
    <header class="mb-6">
        <h1 class="text-3xl font-bold flex items-center gap-2">
            ğŸ›¡ æ”»æ“Šç›£æ§å„€è¡¨æ¿ (Monitoring Dashboard)
        </h1>
        <p class="text-gray-400">å³æ™‚åµæ¸¬èˆ‡è¨˜éŒ„ç³»çµ±æ¥æ”¶åˆ°çš„æƒ¡æ„è«‹æ±‚ã€‚</p>
    </header>

    <!-- çµ±è¨ˆå¡ç‰‡ï¼ˆå…¨æ–°ç¾åŒ–ç‰ˆæœ¬ï¼‰ -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">

    <!-- ç¸½æ”»æ“Šæ¬¡æ•¸ -->
    <div id="total-attacks"
        class="bg-gray-800 border border-gray-700 hover:border-gray-500 transition shadow-lg hover:shadow-xl rounded-xl p-6 border-l-4 border-indigo-500 cursor-pointer">
        <p class="text-sm tracking-wide text-gray-400 mb-1">ç¸½æ”»æ“Šæ¬¡æ•¸</p>
        <p class="text-4xl font-extrabold text-white leading-tight">è¼‰å…¥ä¸­...</p>
    </div>

    <!-- é«˜å±éšª -->
    <div id="high-severity"
        class="bg-gray-800 border border-gray-700 hover:border-gray-500 transition shadow-lg hover:shadow-xl rounded-xl p-6 border-l-4 border-red-500 cursor-pointer">
        <p class="text-sm tracking-wide text-gray-400 mb-1">é«˜å±éšªç­‰ç´š (HIGH)</p>
        <p class="text-4xl font-extrabold text-white leading-tight">è¼‰å…¥ä¸­...</p>
    </div>

    <!-- æœ€æ´»èº IP -->
    <div id="top-attacker"
        class="bg-gray-800 border border-gray-700 hover:border-gray-500 transition shadow-lg hover:shadow-xl rounded-xl p-6 border-l-4 border-green-500 cursor-pointer">
        <p class="text-sm tracking-wide text-gray-400 mb-1">æœ€æ´»èº IP</p>
        <p class="text-xl font-semibold text-white leading-tight truncate">è¼‰å…¥ä¸­...</p>
    </div>

</div>


    <!-- åœ–è¡¨ -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8 ">

        <!-- åœ“é¤…åœ–ï¼ˆåŠ å¤§ 350pxï¼‰ -->
        <div class="card flex flex-col items-center">
            <h3 class="text-lg font-semibold mb-4">æ”»æ“Šé¡å‹åˆ†å¸ƒ (Attack Type Distribution)</h3>
            <div class="w-[350px] h-[350px]">
                <canvas id="attackTypeChart" class="cursor-pointer"></canvas>
            </div>
        </div>

        <!-- é•·æ¢åœ–ï¼ˆå·²ç¸®å°ç‚ºèˆ‡åœ“é¤…åœ–ä¸€è‡´çš„å¤§å°ï¼‰ -->
        <div class="card flex flex-col items-center">
        <h3 class="text-lg font-semibold mb-4">åš´é‡åº¦ç­‰ç´šåˆ†å¸ƒ (Severity Distribution)</h3>
    
            <!-- å›ºå®šé•·æ¢åœ–å¤–å±¤å¤§å° -->
            <div class="w-[350px] h-[350px]">
            <canvas id="severityChart" class="cursor-pointer"></canvas>
            </div>
        </div>


    </div>

    <!-- æ”»æ“Šè¡¨æ ¼ -->
    <div class="card overflow-hidden">
        <div class="p-4 flex justify-between items-center border-b border-gray-700">
            <h2 class="text-xl font-semibold">æœ€æ–°æ”»æ“Šç´€éŒ„</h2>
            <button onclick="fetchAttackLogs()" class="bg-blue-600 hover:bg-blue-500 text-white py-1 px-3 rounded-md text-sm">
                ğŸ”„ æ‰‹å‹•åˆ·æ–°
            </button>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-700">
                <thead class="bg-gray-700">
                    <tr class="text-gray-300">
                        <th class="sticky-header px-6 py-3 text-left text-xs font-medium">æ™‚é–“</th>
                        <th class="sticky-header px-6 py-3 text-left text-xs font-medium">æ”»æ“Šé¡å‹</th>
                        <th class="sticky-header px-6 py-3 text-left text-xs font-medium">åš´é‡åº¦</th>
                        <th class="sticky-header px-6 py-3 text-left text-xs font-medium">ä¾†æº IP</th>
                        <th class="sticky-header px-6 py-3 text-left text-xs font-medium">URL</th>
                        <th class="sticky-header px-6 py-3 text-left text-xs font-medium">Payload</th>
                    </tr>
                </thead>

                <tbody id="attack-log-body" class="divide-y divide-gray-700">
                    <tr><td colspan="6" class="text-center py-4 text-gray-400">è¼‰å…¥ä¸­...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

</div>

<script>
/* ========== åœ–è¡¨éŠ·æ¯€è®Šæ•¸ ========== */
window.attackTypeChart = null;
window.severityChart = null;

/* ========== Badge è‰²ç³» ========== */
function getSeverityBadge(severity) {
    const s = severity.toUpperCase();
    const colors = {
        HIGH: "bg-red-900 text-red-300",
        MEDIUM: "bg-yellow-800 text-yellow-200",
        LOW: "bg-green-800 text-green-200"
    };
    return `<span class="px-2 py-1 text-xs rounded ${colors[s] || "bg-gray-700 text-gray-300"}">${s}</span>`;
}

/* ========== æ¸²æŸ“è¡¨æ ¼ ========== */
function renderTable(logs) {
    const body = document.getElementById("attack-log-body");
    body.innerHTML = "";

    logs.forEach(log => {
        const payload = log.payload.length > 30 ? log.payload.substring(0, 30) + "..." : log.payload;

        const row = `
            <tr class="hover:bg-gray-700/50">
                <td class="px-6 py-3 text-sm">${log.timestamp}</td>
                <td class="px-6 py-3 text-sm text-blue-400">${log.attack_type}</td>
                <td class="px-6 py-3 text-sm">${getSeverityBadge(log.severity)}</td>
                <td class="px-6 py-3 text-sm text-gray-300">${log.ip_address}</td>
                <td class="px-6 py-3 text-sm text-gray-300">${log.url}</td>
                <td class="px-6 py-3 text-sm font-mono text-gray-400">${payload}</td>
            </tr>
        `;
        body.insertAdjacentHTML("beforeend", row);
    });
}

/* ========== åœ–è¡¨æ¸²æŸ“ ========== */
function renderCharts(typeData, severityData) {

    /* åœ“é¤…åœ– */
    if (window.attackTypeChart) window.attackTypeChart.destroy();
    window.attackTypeChart = new Chart(document.getElementById("attackTypeChart"), {
    type: "pie",
    data: {
        labels: Object.keys(typeData),
        datasets: [{
            data: Object.values(typeData),

            // â­ 6 ç¨®å›ºå®šé¡è‰²ï¼ˆä¸æœƒé‡è¤‡ã€æ·±è‰²æ¨¡å¼å‹å–„ï¼‰
            backgroundColor: [
                "#ef4444", // SQLI - ç´…
                "#3b82f6", // XSS - è—
                "#fbbf24", // BRUTE_FORCE - é»ƒ
                "#10b981", // OTHER - ç¶ 
                "#ec4899", // CMD_INJECTION - ç²‰
                "#6366f1"  // PATH_TRAVERSAL - ç´«
            ],

            // â­ Hover é«˜äº®é‚Šæ¡†
            borderColor: "#ffffff",
            borderWidth: 2,

            hoverBorderWidth: 3,
            hoverOffset: 12   // â­ æ”¾å¤§æ•ˆæœ
        }]
    },
    options: {
        plugins: {
            legend: {
                position: "bottom",
                labels: {
                    color: "#cbd5e1", // æ·±è‰²æ–‡å­—
                    padding: 15,
                    usePointStyle: true,   // â­ æ”¹æˆå°åœ“é»æ›´å°ˆæ¥­
                    pointStyle: "circle"
                },

                // â­ åœ–ä¾‹ hover æ•ˆæœ
                onHover: (evt, item) => {
                    evt.chart.getDatasetMeta(0).data[item.index].outerRadius += 10;
                    evt.chart.update();
                },
                onLeave: (evt, item) => {
                    evt.chart.getDatasetMeta(0).data[item.index].outerRadius -= 10;
                    evt.chart.update();
                }
            }
        },

        // â­ è®“ hover å‹•ç•«æ›´é †
        animation: {
            animateRotate: true,
            duration: 600
        },

        maintainAspectRatio: false
    }
});

    // ======= é•·æ¢åœ–ï¼ˆSeverity Distributionï¼‰=======
if (window.severityChart) window.severityChart.destroy();

window.severityChart = new Chart(document.getElementById("severityChart"), {
    type: "bar",
    data: {
        labels: Object.keys(severityData),
        datasets: [{
            data: Object.values(severityData),

            // â­ å›ºå®šä¸‰ç¨®æ·±è‰²ç³» WAF å°ˆæ¥­é¡è‰²
            backgroundColor: [
                "#ef4444", // HIGH - ç´…
                "#f59e0b", // MEDIUM - æ©˜
                "#10b981"  // LOW - ç¶ 
            ],

            // â­ åˆå§‹é‚Šæ¡†
            borderColor: "#ffffff22",
            borderWidth: 2,

            // â­ hover æ”¾å¤§ / é«˜äº®
            hoverBackgroundColor: [
                "#f87171", // HIGH hover
                "#fbbf24", // MEDIUM hover
                "#34d399" // LOW hover
            ],
            hoverBorderColor: "#ffffff",
            hoverBorderWidth: 3
        }]
    },
    options: {
        maintainAspectRatio: false,

        // â­ å‹•ç•«æ›´å¹³æ»‘
        animation: {
            duration: 600,
            easing: "easeOutQuart"
        },

        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    color: "#cbd5e1"
                },
                grid: {
                    color: "#334155"
                }
            },
            x: {
                ticks: {
                    color: "#cbd5e1"
                },
                grid: {
                    display: false
                }
            }
        },

        plugins: {
            legend: { display: false },

            // â­ åœ–ä¾‹ hover ä¹Ÿé«˜äº®ï¼ˆè‹¥ä½ ä¹‹å¾Œæƒ³åŠ  legendï¼‰
            tooltip: {
                enabled: true,
                backgroundColor: "#1e293b",
                titleColor: "#fff",
                bodyColor: "#e2e8f0",
                borderWidth: 1,
                borderColor: "#475569"
            }
        },
    }
});

}

/* ========== çµ±è¨ˆå¡ç‰‡ ========== */
function renderStats(logs) {
    document.querySelector("#total-attacks p:last-child").textContent = logs.length;

    const high = logs.filter(l => l.severity === "HIGH").length;
    document.querySelector("#high-severity p:last-child").textContent = high;

    const ipCount = {};
    logs.forEach(l => ipCount[l.ip_address] = (ipCount[l.ip_address] || 0) + 1);

    let topIP = "ç„¡ç´€éŒ„";
    let max = 0;
    for (const ip in ipCount) {
        if (ipCount[ip] > max) {
            max = ipCount[ip];
            topIP = `${ip} (${max} æ¬¡)`;
        }
    }
    document.querySelector("#top-attacker p:last-child").textContent = topIP;

    const typeCount = { SQLI: 0, XSS: 0, BRUTE_FORCE: 0, OTHER: 0 };
    const sevCount = { HIGH: 0, MEDIUM: 0, LOW: 0 };

    logs.forEach(l => {
        typeCount[l.attack_type] = (typeCount[l.attack_type] || 0) + 1;
        sevCount[l.severity] = (sevCount[l.severity] || 0) + 1;
    });

    renderCharts(typeCount, sevCount);
}

/* ========== å–å¾—è³‡æ–™ ========== */
function fetchAttackLogs() {
    fetch("http://127.0.0.1:5000/logs")
        .then(res => res.json())
        .then(data => {
            renderTable(data);
            renderStats(data);
        });
}

/* è‡ªå‹•åˆ·æ–°ï¼ˆ10 ç§’ï¼‰ */
setInterval(fetchAttackLogs, 5000);

/* åˆæ¬¡è¼‰å…¥ */
fetchAttackLogs();
</script>

</body>
</html>
